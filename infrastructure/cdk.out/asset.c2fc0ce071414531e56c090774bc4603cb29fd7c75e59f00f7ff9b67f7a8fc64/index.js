"use strict";var m=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var E=(t,e)=>{for(var s in e)m(t,s,{get:e[s],enumerable:!0})},N=(t,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of I(e))!b.call(t,o)&&o!==s&&m(t,o,{get:()=>e[o],enumerable:!(n=C(e,o))||n.enumerable});return t};var A=t=>N(m({},"__esModule",{value:!0}),t);var R={};E(R,{handler:()=>G});module.exports=A(R);var a=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/client-apigatewaymanagementapi"),i=require("@aws-sdk/util-dynamodb"),l=new a.DynamoDBClient({}),y=process.env.SESSIONS_TABLE,S=process.env.CONNECTIONS_TABLE,p=process.env.WEBSOCKET_ENDPOINT,h=()=>p?new u.ApiGatewayManagementApiClient({endpoint:`https://${p}`}):null,r={"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type,Authorization","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS"},O=()=>Date.now().toString(36)+Math.random().toString(36).substring(2,7),f=t=>Math.floor(Date.now()/1e3)+t*60,P=async(t,e)=>{let s=h();if(s)try{let n=await l.send(new a.QueryCommand({TableName:S,IndexName:"session-connections",KeyConditionExpression:"sessionId = :sid",ExpressionAttributeValues:(0,i.marshall)({":sid":t})}));if(!n.Items?.length)return;let o=JSON.stringify({type:"session_update",data:e}),d=n.Items.map(async c=>{let g=(0,i.unmarshall)(c);try{await s.send(new u.PostToConnectionCommand({ConnectionId:g.connectionId,Data:Buffer.from(o)}))}catch(w){console.log(`Failed to send to ${g.connectionId}:`,w.message)}});await Promise.all(d)}catch(n){console.error("Error broadcasting to session:",n)}},T=async t=>{try{let{combatState:e,expiresInMinutes:s=480}=JSON.parse(t),n=O(),o=Date.now(),d=f(s),c={id:n,combatState:e,isActive:"true",createdAt:o,updatedAt:o,ttl:d};return await l.send(new a.PutItemCommand({TableName:y,Item:(0,i.marshall)(c)})),{statusCode:201,headers:r,body:JSON.stringify({sessionId:n,expiresAt:new Date(d*1e3).toISOString(),message:"Session created successfully"})}}catch(e){return console.error("Error creating session:",e),{statusCode:500,headers:r,body:JSON.stringify({error:"Failed to create session"})}}},x=async t=>{try{let e=await l.send(new a.GetItemCommand({TableName:y,Key:(0,i.marshall)({id:t})}));if(!e.Item)return{statusCode:404,headers:r,body:JSON.stringify({error:"Session not found"})};let s=(0,i.unmarshall)(e.Item);return s.ttl&&s.ttl<Math.floor(Date.now()/1e3)?{statusCode:404,headers:r,body:JSON.stringify({error:"Session expired"})}:{statusCode:200,headers:r,body:JSON.stringify({sessionId:s.id,combatState:s.combatState,createdAt:s.createdAt,updatedAt:s.updatedAt,expiresAt:s.ttl?new Date(s.ttl*1e3).toISOString():null})}}catch(e){return console.error("Error getting session:",e),{statusCode:500,headers:r,body:JSON.stringify({error:"Failed to get session"})}}},J=async(t,e)=>{try{let{combatState:s,extendTtlMinutes:n}=JSON.parse(e),o=Date.now(),d="SET combatState = :cs, updatedAt = :now",c={":cs":s,":now":o};return n&&(d+=", ttl = :ttl",c[":ttl"]=f(n)),await l.send(new a.UpdateItemCommand({TableName:y,Key:(0,i.marshall)({id:t}),UpdateExpression:d,ExpressionAttributeValues:(0,i.marshall)(c),ConditionExpression:"attribute_exists(id)"})),await P(t,s),{statusCode:200,headers:r,body:JSON.stringify({message:"Session updated successfully",updatedAt:o})}}catch(s){return console.error("Error updating session:",s),s.name==="ConditionalCheckFailedException"?{statusCode:404,headers:r,body:JSON.stringify({error:"Session not found"})}:{statusCode:500,headers:r,body:JSON.stringify({error:"Failed to update session"})}}},D=async t=>{try{await l.send(new a.DeleteItemCommand({TableName:y,Key:(0,i.marshall)({id:t})}));let e=h();if(e){let s=await l.send(new a.QueryCommand({TableName:S,IndexName:"session-connections",KeyConditionExpression:"sessionId = :sid",ExpressionAttributeValues:(0,i.marshall)({":sid":t})}));if(s.Items?.length){let n=JSON.stringify({type:"session_closed",message:"Session has been ended by the host"});await Promise.all(s.Items.map(async o=>{let d=(0,i.unmarshall)(o);try{await e.send(new u.PostToConnectionCommand({ConnectionId:d.connectionId,Data:Buffer.from(n)}))}catch{}}))}}return{statusCode:200,headers:r,body:JSON.stringify({message:"Session deleted successfully"})}}catch(e){return console.error("Error deleting session:",e),{statusCode:500,headers:r,body:JSON.stringify({error:"Failed to delete session"})}}},G=async t=>{console.log("Event:",JSON.stringify(t,null,2));let e=t.requestContext?.http?.method||t.httpMethod,s=t.requestContext?.http?.path||t.path,n=t.pathParameters?.sessionId;if(e==="OPTIONS")return{statusCode:200,headers:r,body:""};if(s==="/sessions"&&e==="POST")return T(t.body||"{}");if(s.startsWith("/sessions/")&&n)switch(e){case"GET":return x(n);case"PUT":return J(n,t.body||"{}");case"DELETE":return D(n)}return{statusCode:404,headers:r,body:JSON.stringify({error:"Not found"})}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
