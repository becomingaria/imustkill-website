"use strict";var m=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var h=(e,t)=>{for(var n in t)m(e,n,{get:t[n],enumerable:!0})},f=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of E(t))!I.call(e,s)&&s!==n&&m(e,s,{get:()=>t[s],enumerable:!(o=g(t,s))||o.enumerable});return e};var N=e=>f(m({},"__esModule",{value:!0}),e);var W={};h(W,{handler:()=>D});module.exports=N(W);var a=require("@aws-sdk/client-dynamodb"),b=require("@aws-sdk/client-apigatewaymanagementapi"),r=require("@aws-sdk/util-dynamodb"),i=new a.DynamoDBClient({}),l=process.env.CONNECTIONS_TABLE,x=process.env.SESSIONS_TABLE,y=()=>Math.floor(Date.now()/1e3)+7200,d=e=>{let{domainName:t,stage:n}=e.requestContext;return new b.ApiGatewayManagementApiClient({endpoint:`https://${t}/${n}`})},c=async(e,t,n)=>{try{return await e.send(new b.PostToConnectionCommand({ConnectionId:t,Data:Buffer.from(JSON.stringify(n))})),!0}catch(o){return console.log(`Failed to send to ${t}:`,o.message),!1}},A=async e=>{let t=e.requestContext.connectionId;console.log(`New connection: ${t}`);try{return await i.send(new a.PutItemCommand({TableName:l,Item:(0,r.marshall)({connectionId:t,sessionId:"UNSUBSCRIBED",connectedAt:Date.now(),ttl:y()})})),{statusCode:200}}catch(n){return console.error("Error handling connect:",n),{statusCode:500}}},k=async e=>{let t=e.requestContext.connectionId;console.log(`Disconnected: ${t}`);try{return await i.send(new a.DeleteItemCommand({TableName:l,Key:(0,r.marshall)({connectionId:t})})),{statusCode:200}}catch(n){return console.error("Error handling disconnect:",n),{statusCode:500}}},w=async e=>{let t=e.requestContext.connectionId,n=d(e);try{let o=JSON.parse(e.body||"{}"),{sessionId:s}=o;if(!s)return await c(n,t,{type:"error",message:"sessionId is required"}),{statusCode:400};let C=await i.send(new a.GetItemCommand({TableName:x,Key:(0,r.marshall)({id:s})}));if(!C.Item)return await c(n,t,{type:"error",message:"Session not found"}),{statusCode:404};let u=(0,r.unmarshall)(C.Item);return u.ttl&&u.ttl<Math.floor(Date.now()/1e3)?(await c(n,t,{type:"error",message:"Session has expired"}),{statusCode:410}):(await i.send(new a.UpdateItemCommand({TableName:l,Key:(0,r.marshall)({connectionId:t}),UpdateExpression:"SET sessionId = :sid, subscribedAt = :now, #ttl = :ttl",ExpressionAttributeNames:{"#ttl":"ttl"},ExpressionAttributeValues:(0,r.marshall)({":sid":s,":now":Date.now(),":ttl":y()})})),await c(n,t,{type:"subscribed",sessionId:s,combatState:u.combatState,expiresAt:u.ttl?new Date(u.ttl*1e3).toISOString():null}),console.log(`Connection ${t} subscribed to session ${s}`),{statusCode:200})}catch(o){return console.error("Error handling subscribe:",o),await c(n,t,{type:"error",message:"Failed to subscribe"}),{statusCode:500}}},S=async e=>{let t=e.requestContext.connectionId,n=d(e);try{return await i.send(new a.UpdateItemCommand({TableName:l,Key:(0,r.marshall)({connectionId:t}),UpdateExpression:"SET #ttl = :ttl, lastPing = :now",ExpressionAttributeNames:{"#ttl":"ttl"},ExpressionAttributeValues:(0,r.marshall)({":ttl":y(),":now":Date.now()})})),await c(n,t,{type:"pong"}),{statusCode:200}}catch(o){return console.error("Error handling ping:",o),{statusCode:500}}},p=async e=>{let t=e.requestContext.connectionId,n=d(e);try{return await i.send(new a.UpdateItemCommand({TableName:l,Key:(0,r.marshall)({connectionId:t}),UpdateExpression:"SET sessionId = :unsub, unsubscribedAt = :now",ExpressionAttributeValues:(0,r.marshall)({":unsub":"UNSUBSCRIBED",":now":Date.now()})})),await c(n,t,{type:"unsubscribed",message:"Successfully unsubscribed from session"}),{statusCode:200}}catch(o){return console.error("Error handling unsubscribe:",o),{statusCode:500}}},T=async e=>{let t=e.requestContext.connectionId,n=d(e);console.log(`Default route for ${t}:`,e.body);try{let s=JSON.parse(e.body||"{}").action;switch(s){case"subscribe":return w(e);case"unsubscribe":return p(e);case"ping":return S(e);default:return await c(n,t,{type:"error",message:`Unknown action: ${s}. Valid actions: subscribe, unsubscribe, ping`}),{statusCode:400}}}catch(o){console.error("Error in default handler:",o);let s=d(e);return await c(s,t,{type:"error",message:"Invalid message format. Expected JSON with 'action' field."}),{statusCode:400}}},D=async e=>{console.log("Event:",JSON.stringify(e,null,2));let t=e.requestContext.routeKey;switch(t){case"$connect":return A(e);case"$disconnect":return k(e);case"subscribe":return w(e);case"unsubscribe":return p(e);case"ping":return S(e);case"$default":return T(e);default:return console.log(`Unknown route: ${t}`),{statusCode:400}}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
